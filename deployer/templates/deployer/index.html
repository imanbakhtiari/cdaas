<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Deployer - Repositories</title>
  </head>
  <body class="p-4">
    <div class="container">
      <h1 class="mb-4">Repositories</h1>
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>URL</th>
            <th>Branch</th>
            <th>Registry Domain</th>
            <th>Namespace</th>
            <th>Actions</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody>
          {% for r in repos %}
          <tr>
            <td>{{ r.name }}</td>
            <td><a href="{{ r.url }}" target="_blank">{{ r.url }}</a></td>
            <td>{{ r.branch }}</td>
            <td>{{ r.registry_domain|default:"Not configured" }}</td>
            <td>{{ r.kubernetes_namespace }}</td>
            <td>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-bs-toggle="modal"
                data-bs-target="#configModal"
                data-repo="{{ r.name }}"
                data-registry="{{ r.registry_domain }}"
                data-registry-repo="{{ r.nexus_repository|default:'' }}"
                data-registry-username="{{ r.nexus_username|default:'' }}"
                data-k8s-namespace="{{ r.kubernetes_namespace }}"
                data-kubeconfig-id="kubeconfig-{{ r.id }}"
              >
                View config
              </button>
              <textarea id="kubeconfig-{{ r.id }}" class="d-none">{{ r.kubeconfig|default_if_none:'' }}</textarea>
            </td>
            <td>{{ r.created_at }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7">No repositories configured.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <hr class="my-5">
      <h2 class="mb-3">Add Repository</h2>
      <form method="post" class="row g-3">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="col-md-6">
          <label class="form-label">Name</label>
          {{ form.name }}
          {{ form.name.errors }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Git URL</label>
          {{ form.url }}
          {{ form.url.errors }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Branch</label>
          {{ form.branch }}
          {{ form.branch.errors }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Git Username</label>
          {{ form.username }}
          {{ form.username.errors }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Git Password/Token</label>
          {{ form.password }}
          {{ form.password.errors }}
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#advancedConfigModal">
            Configure registry & Kubernetes
          </button>
        </div>
        <!-- Advanced config modal (inside the form so inputs submit normally) -->
        <div class="modal fade" id="advancedConfigModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Registry & Kubernetes configuration</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nexus Registry</label>
                  {{ form.nexus_registry }}
                  {{ form.nexus_registry.errors }}
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nexus Repository</label>
                  {{ form.nexus_repository }}
                  {{ form.nexus_repository.errors }}
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nexus Username</label>
                  {{ form.nexus_username }}
                  {{ form.nexus_username.errors }}
                </div>
                <div class="col-md-6">
                  <label class="form-label">Nexus Password</label>
                  {{ form.nexus_password }}
                  {{ form.nexus_password.errors }}
                </div>
                <div class="col-md-4">
                  <label class="form-label">Kubernetes Namespace</label>
                  {{ form.kubernetes_namespace }}
                  {{ form.kubernetes_namespace.errors }}
                </div>
                <div class="col-12">
                  <label class="form-label">Kubeconfig (YAML)</label>
                  {{ form.kubeconfig }}
                  {{ form.kubeconfig.errors }}
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Done</button>
            </div>
          </div>
        </div>
      </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Save Repository</button>
        </div>
      </form>
    </div>
    <!-- Config modal -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Repository configuration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h6>Registry</h6>
            <dl class="row">
              <dt class="col-sm-3">Domain</dt>
              <dd class="col-sm-9" id="modalRegistryDomain"></dd>
              <dt class="col-sm-3">Repository</dt>
              <dd class="col-sm-9" id="modalRegistryRepo"></dd>
              <dt class="col-sm-3">Username</dt>
              <dd class="col-sm-9" id="modalRegistryUsername"></dd>
            </dl>
            <hr>
            <h6>Kubernetes</h6>
            <dl class="row">
              <dt class="col-sm-3">Namespace</dt>
              <dd class="col-sm-9" id="modalNamespace"></dd>
            </dl>
            <label class="form-label mt-3">Kubeconfig</label>
            <pre class="bg-light border rounded p-3" id="modalKubeconfig" style="max-height: 300px; overflow:auto;"></pre>
          </div>
        </div>
      </div>
    </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const configModal = document.getElementById('configModal');
      configModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const repoName = button.getAttribute('data-repo') || 'Repository';
        const registryDomain = button.getAttribute('data-registry') || 'Not configured';
        const registryRepo = button.getAttribute('data-registry-repo') || 'Not configured';
        const registryUsername = button.getAttribute('data-registry-username') || 'Not configured';
        const namespaceValue = button.getAttribute('data-k8s-namespace') || 'default';
        const kubeconfigId = button.getAttribute('data-kubeconfig-id');
        const kubeconfigSource = document.getElementById(kubeconfigId);
        const kubeconfigText = kubeconfigSource ? kubeconfigSource.textContent.trim() : '';

        configModal.querySelector('.modal-title').textContent = `${repoName} configuration`;
        document.getElementById('modalRegistryDomain').textContent = registryDomain || 'Not configured';
        document.getElementById('modalRegistryRepo').textContent = registryRepo || 'Not configured';
        document.getElementById('modalRegistryUsername').textContent = registryUsername || 'Not configured';
        document.getElementById('modalNamespace').textContent = namespaceValue;
        document.getElementById('modalKubeconfig').textContent = kubeconfigText || 'No kubeconfig stored.';
      });
    </script>
  </body>
  </html>
